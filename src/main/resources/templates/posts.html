<!-- src/main/resources/templates/posts.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8"/>
  <title>XYVOX Posts</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Orbitron', sans-serif;
      background: url('/images/xyvox-background-mainpage.png') no-repeat center center;
      background-size: cover;
      color: #E0DFFF;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    a { text-decoration: none; color: inherit; }
    button { cursor: pointer; border: none; background: none; }

    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 60px;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      flex-shrink: 0;
    }
    .navbar-left {
      display: flex;
      align-items: center;
    }
    .navbar-left img.logo {
      width: 40px;
      height: 40px;
      margin-right: 16px;
      filter: drop-shadow(0 0 8px #BB00FF);
    }
    .navbar-left .logo-text {
      font-family: 'ArsenicaTrialMedium', sans-serif;
      font-size: 2rem;
      color: #BB00FF;
      text-shadow:
              0 0 12px rgba(255, 255, 255, 0.8),
              0 0 24px rgba(187, 0, 255, 0.6);
      margin-right: 40px;
    }
    .navbar-left .nav-links a {
      margin-right: 32px;
      font-size: 1.1rem;
      position: relative;
      transition: color 0.2s ease-in-out;
      animation: pulse 4s infinite;
    }
    .navbar-left .nav-links a::after {
      content: '';
      position: absolute;
      bottom: -6px;
      left: 0;
      width: 0%;
      height: 3px;
      background: #BB00FF;
      transition: width 0.2s;
    }
    .navbar-left .nav-links a:hover {
      color: #FFFFFF;
    }
    .navbar-left .nav-links a:hover::after {
      width: 100%;
    }
    .navbar-left .nav-links .active {
      color: #FFFFFF;
    }
    .navbar-right .btn.logout {
      margin-left: 24px;
      padding: 8px 20px;
      font-size: 1rem;
      border: 2px solid #BB00FF;
      border-radius: 24px;
      background: none;
      color: #E0DFFF;
      text-transform: uppercase;
      transition: all 0.2s ease-in-out;
      animation: pulse 3.5s infinite;
    }
    .navbar-right .btn.logout:hover {
      background: rgba(187, 0, 255, 0.3);
      border-color: #FFFFFF;
      color: #FFFFFF;
      text-shadow:
              0 0 12px rgba(255, 255, 255, 0.9),
              0 0 24px rgba(255, 255, 255, 0.7);
      transform: scale(1.05);
    }

    .navbar-right .btn {
      margin-left: 24px;
      padding: 12px 28px;
      font-size: 1rem;
      border: 2px solid transparent;
      border-radius: 30px;
      background: none;
      color: #E0DFFF;
      cursor: pointer;
      text-transform: uppercase;
      transition: all 0.2s ease-in-out;
      animation: pulse 3.5s infinite;
    }
    .navbar-right .btn.login {
      border-color: transparent;
    }
    .navbar-right .btn.login:hover {
      color: #FFFFFF;
      text-shadow:
              0 0 12px rgba(187, 0, 255, 0.9),
              0 0 24px rgba(187, 0, 255, 0.7);
      transform: scale(1.05);
    }
    .navbar-right .btn.signup {
      border: 2px solid #BB00FF;
    }
    .navbar-right .btn.signup:hover {
      background: rgba(187, 0, 255, 0.3);
      border-color: #FFFFFF;
      color: #FFFFFF;
      text-shadow:
              0 0 12px rgba(255, 255, 255, 0.9),
              0 0 24px rgba(255, 255, 255, 0.7);
      transform: scale(1.05);
    }

    @keyframes pulse {
      0% {
        text-shadow:
                0 0 8px rgba(187, 0, 255, 0.6),
                0 0 16px rgba(187, 0, 255, 0.4);
      }
      50% {
        text-shadow:
                0 0 16px rgba(255, 255, 255, 0.8),
                0 0 32px rgba(187, 0, 255, 0.6);
      }
      100% {
        text-shadow:
                0 0 8px rgba(187, 0, 255, 0.6),
                0 0 16px rgba(187, 0, 255, 0.4);
      }
    }

    .posts-container {
      padding: 20px 60px;
      flex: 1;
      overflow-y: auto;
    }
    .post-item {
      background: rgba(46, 0, 70, 0.8);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
      backdrop-filter: blur(4px);
      box-shadow: 0 0 20px rgba(187, 0, 255, 0.6);
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex;
      flex-direction: column;
    }
    .post-item:hover {
      box-shadow: 0 0 30px rgba(255, 255, 255, 0.7);
    }
    .post-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .post-author {
      font-size: 1rem;
      color: #BB00FF;
      font-weight: bold;
      text-shadow:
              0 0 8px rgba(255, 255, 255, 0.8),
              0 0 16px rgba(187, 0, 255, 0.6);
    }
    .post-time {
      font-size: 0.85rem;
      color: #D8CFFF;
      text-shadow: 0 0 4px rgba(255,255,255,0.6);
    }
    .post-content {
      margin: 12px 0;
      font-size: 1rem;
      color: #E0DFFF;
      line-height: 1.5;
    }
    .post-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .post-actions-editor {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 8px;
    }
    .action-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.9rem;
      padding: 6px 12px;
      border-radius: 20px;
      transition: transform 0.2s, box-shadow 0.2s;
      background: rgba(187, 0, 255, 0.3);
      color: #000;
      box-shadow: 0 0 8px rgba(174, 107, 255, 0.6);
    }
    .action-btn:hover {
      box-shadow: 0 0 12px rgba(255, 255, 255, 0.7);
    }
    .like-btn {
      background: rgba(174, 107, 255, 0.6);
    }
    .comment-btn {
      background: #9d4edd;
    }
    .edit-btn {
      background: #7300ff;
    }
    .delete-btn {
      background: #c96bff;
    }

    .comments-section {
      margin-top: 16px;
      border-top: 1px solid rgba(255,255,255,0.1);
      padding-top: 12px;
      flex-direction: column;
      gap: 12px;
    }
    .comment-item {
      background: rgba(46, 0, 70, 0.8);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 0 12px rgba(187, 0, 255, 0.6);
      display: flex;
      flex-direction: column;
    }
    .comment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .comment-author {
      font-size: 0.9rem;
      color: #BB00FF;
      font-weight: bold;
    }
    .comment-time {
      font-size: 0.8rem;
      color: #D8CFFF;
    }
    .comment-content {
      font-size: 0.9rem;
      color: #E0DFFF;
      margin-bottom: 8px;
    }
    .comment-actions {
      display: flex;
      gap: 8px;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    .modal {
      background: rgba(46, 0, 70, 0.9);
      border-radius: 16px;
      padding: 24px;
      width: 500px;
      max-width: 90%;
      box-shadow: 0 0 24px rgba(187, 0, 255, 0.6);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .modal textarea {
      width: 100%;
      height: 150px;
      padding: 12px;
      border: none;
      border-radius: 12px;
      background: #3e0054;
      color: #fff;
      font-size: 1rem;
      box-shadow: 0 0 8px #c77dff44;
      resize: vertical;
    }
    .modal textarea:focus {
      outline: none;
      box-shadow: 0 0 16px #c77dff;
    }
    .modal .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    .modal .modal-actions button {
      padding: 8px 20px;
      border-radius: 20px;
      font-size: 0.9rem;
      transition: transform 0.2s, box-shadow 0.2s;
      background: #BB00FF;
      color: #000;
      box-shadow: 0 0 12px rgba(187, 0, 255, 0.6);
    }
    .modal .modal-actions button:hover {
      transform: scale(1.05);
      box-shadow: 0 0 24px rgba(255, 255, 255, 0.7);
    }

    .comment-form-wrapper {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      background: rgba(123, 50, 161, 0.4);
      padding: 12px;
      border-radius: 12px;
      box-shadow: inset 0 0 12px rgba(123, 50, 161, 0.6);
    }

    .comment-input {
      width: 100%;
      padding: 10px 12px;
      border: none;
      border-radius: 8px;
      background: rgba(46, 0, 70, 0.8);
      color: #E0DFFF;
      font-size: 0.95rem;
      line-height: 1.4;
      resize: vertical;
      min-height: 80px;
      box-shadow: inset 0 0 8px rgba(187, 0, 255, 0.6);
    }

    .comment-input:focus {
      outline: none;
      box-shadow: inset 0 0 12px rgba(187, 0, 255, 0.8);
    }

    .comment-submit-btn {
      margin-top: 8px;
      padding: 8px 16px;
      background: #9d4edd;
      color: #000;
      font-size: 0.9rem;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(157, 78, 221, 0.6);
      transition: transform 0.2s, box-shadow 0.2s;
      display: inline-block;
    }

    .comment-submit-btn:hover {
      transform: scale(1.03);
      box-shadow: 0 0 12px rgba(255, 255, 255, 0.7);
    }
    .hidden {
      display: none;
    }
  </style>
  <script th:inline="javascript">
    /*<![CDATA[*/
    function toggleComments(postId) {
      const section = document.getElementById('comments-' + postId);
      if (!section) return;
      section.classList.toggle('hidden');
    }

    const editUrlBase = /*[[@{/xyvox/api/v1/posts/edit}]]*/'';


    function openWriteModal(editMode, postId) {

      console.log("edit mode " + editMode);
      console.log("post id " + postId);

      const overlay = document.getElementById('modalOverlay');
      const textarea = document.getElementById('postContent');
      const form     = document.getElementById('writePostForm');
      const title    = document.getElementById('modalTitle');

      if (editMode) {
        const existingContent = document
                .getElementById('post-content-' + postId)
                .innerText;
        textarea.value = existingContent;
        console.log(" edit url " + editUrlBase);

        form.action = editUrlBase + '/' + postId;
        title.innerText = 'Edit Post';
      } else {
        textarea.value = '';
        form.action = /*[[@{/xyvox/api/v1/posts/create}]]*/ '';
        title.innerText = 'Write Post';
      }

      overlay.style.display = 'flex';
    }

    function closeWriteModal() {
      document.getElementById('modalOverlay').style.display = 'none';
    }



    var csrfToken  = /*[[${_csrf.token}]]*/ '';
    var csrfHeader = /*[[${_csrf.headerName}]]*/ '';

    var likeUrlBase   = /*[[@{/xyvox/api/v1/posts/like/}]]*/ '/xyvox/api/v1/posts/like/';
    var unlikeUrlBase = /*[[@{/xyvox/api/v1/posts/unlike/}]]*/ '/xyvox/api/v1/posts/unlike/';

    function likePost(postId) {
      fetch(likeUrlBase + postId, {
        method: 'POST',
        credentials: 'same-origin',
        headers: { [csrfHeader]: csrfToken }
      })
              .then(resp => {
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                return resp;
              })
              .then(() => location.reload())
              .catch(err => console.error('Like failed:', err));
    }

    function unlikePost(postId) {
      fetch(unlikeUrlBase + postId, {
        method: 'POST',
        credentials: 'same-origin',
        headers: { [csrfHeader]: csrfToken }
      })
              .then(resp => {
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                return resp;
              })
              .then(() => location.reload())
              .catch(err => console.error('Unlike failed:', err));
    }
    /*]]>*/
  </script>
</head>
<body>
<div class="navbar">
  <div class="navbar-left">
    <img class="logo" th:src="@{/images/logo.png}" alt="Logo"/>
    <span class="logo-text">XYVOX</span>
    <div class="nav-links">
      <a th:href="@{/xyvox/api/v1/trade}">Trade</a>
      <a th:href="@{/xyvox/api/v1/news}">News</a>
      <a th:href="@{/xyvox/api/v1/posts}" class="active">Posts</a>
      <a th:href="@{/xyvox/api/v1/users/my-profile}">Profile</a>
    </div>
  </div>
  <div class="navbar-right">
    <a sec:authorize="!isAuthenticated()" th:href="@{/login}" class="btn login">Log In</a>
    <a sec:authorize="!isAuthenticated()" th:href="@{/signup}" class="btn signup">Sign Up</a>
    <form sec:authorize="isAuthenticated()" th:action="@{/logout}" method="post" style="display:inline;">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
      <button type="submit" class="btn logout">Log Out</button>
    </form>
  </div>
</div>


<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>


<div class="posts-container">
  <div sec:authorize="isAuthenticated()">
    <button class="action-btn like-btn" style="width: 120px; justify-content: center;"
            onclick="openWriteModal(false, 0, '')">
      üìù Write Post
    </button>
  </div>

  <div th:each="post : ${posts}">
    <div class="post-item">
      <div class="post-header">
        <span class="post-author" th:text="${post.authorUsername}">Author</span>
        <span class="post-time" th:text="${#dates.format(post.createdAt, 'yyyy-MM-dd HH:mm')}">2025-06-06 15:00</span>
      </div>
      <p class="post-content"
         th:id="'post-content-' + ${post.id}"
         th:text="${post.content}">
        Post content...
      </p>

      <div class="post-actions-editor">

        <div sec:authorize="isAuthenticated()">
          <button th:if="${!post.likedByCurrentUser}"
                  class="action-btn like-btn"
                  th:onclick="|likePost(${post.id})|">
            üëç <span th:text="${post.likeCount}">0</span>
          </button>
          <button th:if="${post.likedByCurrentUser}"
                  class="action-btn delete-btn"
                  th:onclick="|unlikePost(${post.id})|">
            üö´ <span th:text="${post.likeCount}">0</span>
          </button>
        </div>
        <div sec:authorize="!isAuthenticated()">
          <button class="action-btn like-btn" disabled>
            üëç <span th:text="${post.likeCount}">0</span>
          </button>
        </div>



        <div th:if="${#authentication.name == post.authorEmail}"
             class="post-actions-editor">
          <button class="action-btn edit-btn"
                  th:onclick="|openWriteModal(true, ${post.id})|">
            ‚úèÔ∏è Edit
          </button>
          <form th:action="@{/xyvox/api/v1/posts/delete/{id}(id=${post.id})}"
                method="post" style="display:inline;">
            <input type="hidden" th:name="${_csrf.parameterName}"
                   th:value="${_csrf.token}"/>
            <button type="submit" class="action-btn delete-btn"
                    onclick="return confirm('Delete this post?')">üóëÔ∏è Delete</button>
          </form>
        </div>

        <div sec:authorize="hasAnyRole('MODERATOR','ADMIN')"
             th:if="${#authentication.name != post.authorEmail}"  class="post-actions-editor">
          <form th:action="@{/xyvox/api/v1/posts/delete/{id}(id=${post.id})}"
                method="post" style="display:inline">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button type="submit" class="action-btn delete-btn"
                    onclick="return confirm('Delete this post?')">üóëÔ∏è Delete</button>
          </form>
        </div>
      </div>

      <button class="action-btn comment-btn"
              th:onclick="|toggleComments(${post.id})|">
        üí¨ <span th:text="${post.commentCount}">0</span>
      </button>

      <div class="comments-section hidden" th:id="'comments-' + ${post.id}">

        <div th:each="comment : ${post.comments}">
          <div class="comment-item">
            <div class="comment-header">
              <span class="comment-author" th:text="${comment.authorUsername}">Commenter</span>
              <span class="comment-time"
                    th:text="${#dates.format(comment.createdAt,'yyyy-MM-dd HH:mm')}">
          2025-06-06 15:30
        </span>
            </div>
            <p class="comment-content" th:text="${comment.content}">Comment content...</p>

            <div class="comment-actions"
                 th:if="${#authentication.name == comment.authorEmail}">
              <a th:href="@{/xyvox/api/v1/comments/edit/{id}(id=${comment.id})}"
                 class="action-btn edit-btn">
                ‚úèÔ∏è Edit
              </a>
              <form th:action="@{/xyvox/api/v1/comments/delete/{id}(id=${comment.id})}"
                    method="post" style="display:inline;">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit" class="action-btn delete-btn"
                        onclick="return confirm('Delete this comment?')">üóëÔ∏è Delete</button>
              </form>
            </div>
            <div class="comment-actions"
                 sec:authorize="hasAnyRole('MODERATOR','ADMIN')">
              <div th:if="${#authentication.name != comment.authorEmail}">
                <form th:action="@{/xyvox/api/v1/comments/delete/{id}(id=${comment.id})}"
                      method="post" style="display:inline;">
                  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                  <button type="submit" class="action-btn delete-btn"
                          onclick="return confirm('Delete this comment?')">üóëÔ∏è Delete</button>
                </form>
              </div>

            </div>
          </div>
        </div>

        <form th:action="@{/xyvox/api/v1/posts/comments/create}"
              method="post"
              class="comment-form-wrapper">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
          <input type="hidden" name="postId" th:value="${post.id}"/>

          <textarea name="content"
                    placeholder="Write a comment..."
                    class="comment-input"
                    required></textarea>

          <button type="submit" class="comment-submit-btn">‚ûï Add Comment</button>
        </form>
      </div>
    </div>
  </div>

  <div th:if="${#lists.isEmpty(posts)}" style="text-align:center; margin-top:40px;">
    <span style="font-size:1.2rem; color:#D8CFFF; font-style:italic;">
      No posts yet. Be the first to write one!
    </span>
  </div>
</div>

<div id="modalOverlay" class="modal-overlay" style="display:none;">
  <div class="modal">
    <form id="writePostForm" method="post">
      <input type="hidden" name="id" id="modalPostId"/>

      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

      <h2 id="modalTitle">Write Post</h2>
      <textarea id="postContent"
                name="content"
                placeholder="Share your thoughts..."
                required></textarea>
      <div class="modal-actions">
        <button type="button" onclick="closeWriteModal()">Cancel</button>
        <button type="submit">Submit</button>
      </div>
    </form>
  </div>
</div>
</body>
</html>
